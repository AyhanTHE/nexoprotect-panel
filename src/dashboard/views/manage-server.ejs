<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion de <%= guild.name %></title>
    <link rel="stylesheet" href="/css/manage.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
</head>
<body>
    <div class="manage-layout">
        <aside class="manage-sidebar">
            <div class="sidebar-header">
                <img src="<%= guild.icon ? `https://cdn.discordapp.com/icons/${guild.id}/${guild.icon}.png` : '/images/default-icon.png' %>" alt="Ic√¥ne du serveur" class="server-icon-large">
                <h2 class="server-name-large"><%= guild.name %></h2>
            </div>
            
            <nav class="manage-nav">
                <a href="#" class="nav-category"><i class="fas fa-tachometer-alt"></i><span>Tableau de bord</span></a>
                <div class="nav-divider"></div>
                <h3 class="nav-title">Modules</h3>
                <a href="#" class="nav-category active"><i class="fas fa-users"></i><span>Arriv√©es & D√©parts</span></a>
                <a href="#" class="nav-category"><i class="fas fa-shield-alt"></i><span>Mod√©ration</span></a>
                <a href="#" class="nav-category"><i class="fas fa-gamepad"></i><span>Niveaux</span></a>
            </nav>

            <div class="user-profile-section">
                <% if (user) { %>
                    <div class="profile-info">
                        <img src="https://cdn.discordapp.com/avatars/<%= user.id %>/<%= user.avatar %>.png?size=64" alt="Avatar" class="profile-avatar-small">
                        <div class="profile-text">
                            <span class="profile-name"><%= user.username %></span>
                            <span class="profile-grade <%= user.grade === 'VIP' ? 'vip' : '' %>">
                                <i class="fas <%= user.grade === 'VIP' ? 'fa-crown' : 'fa-user' %>"></i> <%= user.grade %>
                            </span>
                        </div>
                    </div>
                <% } %>
                <a href="/dashboard" class="btn-back"><i class="fas fa-arrow-left"></i><span>Retour aux serveurs</span></a>
            </div>
        </aside>

        <main class="manage-main-content">
            <header class="manage-header">
                <h1>Arriv√©es et d√©parts</h1>
                <p>Configurez ici les messages de bienvenue et d'au revoir pour votre serveur.</p>
            </header>

            <form id="settings-form">
                <!-- MODULE BIENVENUE -->
                <details class="module-accordion" open>
                    <summary class="module-summary">
                        <div class="summary-title"><i class="fas fa-hand-sparkles"></i><h3>Messages de Bienvenue</h3></div>
                        <label class="switch"><input type="checkbox" name="welcomeEnabled" <%= settings.welcome && settings.welcome.enabled ? 'checked' : '' %>><span class="slider round"></span></label>
                    </summary>
                    <div class="module-content">
                        <div class="settings-grid">
                            <div class="settings-column">
                                <label for="welcome-channel">Salon des messages de bienvenue</label>
                                <select id="welcome-channel" name="welcomeChannelId" class="select-box">
                                    <option value="">S√©lectionnez un salon</option>
                                    <% channels.forEach(channel => { %><option value="<%= channel.id %>" <%= settings.welcome && settings.welcome.channelId === channel.id ? 'selected' : '' %>>#<%= channel.name %></option><% }); %>
                                </select>

                                <label for="welcome-message">Message personnalis√©</label>
                                <textarea id="welcome-message" name="welcomeMessage" class="textarea-box" placeholder="Ex: Bienvenue {user.username} !"><%= settings.welcome ? settings.welcome.message : '' %></textarea>
                                <p class="variable-info">Variables: {user.username}, {user.mention}, {server.name}</p>

                                <label>Banni√®re de bienvenue</label>
                                <% if (user.grade === 'VIP') { %>
                                    <div class="setting-vip"><i class="fas fa-crown vip-icon"></i><input type="text" name="welcomeBannerUrl" class="text-input" placeholder="URL de votre image/GIF" value="<%= settings.welcome ? settings.welcome.bannerUrl : '' %>"></div>
                                <% } else { %>
                                    <div class="setting-locked"><p>Cette fonctionnalit√© est r√©serv√©e aux membres VIP.</p><button type="button" class="btn-vip-upgrade"><i class="fas fa-star"></i> Devenir VIP</button></div>
                                <% } %>
                            </div>
                            <div class="preview-column">
                                <label>Pr√©visualisation</label>
                                <div class="discord-preview"><div class="discord-message"><img src="https://cdn.discordapp.com/embed/avatars/1.png" class="discord-avatar" alt="avatar"><div class="discord-message-content"><div class="discord-user-info"><span class="discord-username">NexoProtect</span><span class="discord-bot-tag">APP</span></div><div class="discord-text"><p>Ho ! Un nouveau membre !</p><p>‚ú® Bienvenue, <%= user.username %> ! ‚ú®</p></div></div></div></div>
                            </div>
                        </div>
                    </div>
                </details>

                <!-- MODULE AU REVOIR -->
                <details class="module-accordion">
                     <summary class="module-summary">
                        <div class="summary-title"><i class="fas fa-door-open"></i><h3>Messages d'Au Revoir</h3></div>
                        <label class="switch"><input type="checkbox" name="goodbyeEnabled" <%= settings.goodbye && settings.goodbye.enabled ? 'checked' : '' %>><span class="slider round"></span></label>
                    </summary>
                     <div class="module-content">
                        <div class="settings-grid">
                            <div class="settings-column">
                                <label for="goodbye-channel">Salon des messages d'au revoir</label>
                                <select id="goodbye-channel" name="goodbyeChannelId" class="select-box">
                                     <option value="">S√©lectionnez un salon</option>
                                     <% channels.forEach(channel => { %><option value="<%= channel.id %>" <%= settings.goodbye && settings.goodbye.channelId === channel.id ? 'selected' : '' %>>#<%= channel.name %></option><% }); %>
                                </select>
                                <label for="goodbye-message">Message personnalis√©</label>
                                <textarea id="goodbye-message" name="goodbyeMessage" class="textarea-box" placeholder="Ex: Au revoir {user.username}..."><%= settings.goodbye ? settings.goodbye.message : '' %></textarea>
                            </div>
                            <div class="preview-column">
                                <label>Pr√©visualisation</label>
                                <div class="discord-preview"><div class="discord-message"><img src="https://cdn.discordapp.com/embed/avatars/1.png" class="discord-avatar" alt="avatar"><div class="discord-message-content"><div class="discord-user-info"><span class="discord-username">NexoProtect</span><span class="discord-bot-tag">APP</span></div><div class="discord-text"><p>Un membre vient de partir üò¢</p><p>√Ä bient√¥t, <%= user.username %> !</p></div></div></div></div>
                            </div>
                        </div>
                    </div>
                </details>
            </form>
        </main>
    </div>

    <div class="save-bar" id="save-bar">
        <p id="save-status">Des changements non sauvegard√©s.</p>
        <button type="button" id="save-button" class="btn-save"><i class="fas fa-save"></i> Enregistrer les changements</button>
    </div>

    <script>
        // Script pour g√©rer la sauvegarde
        const saveButton = document.getElementById('save-button');
        const saveStatus = document.getElementById('save-status');
        const form = document.getElementById('settings-form');
        
        form.addEventListener('input', () => {
            document.getElementById('save-bar').classList.add('visible');
        });

        saveButton.addEventListener('click', () => {
            saveButton.disabled = true;
            saveButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enregistrement...';

            const guildId = window.location.pathname.split('/').pop();
            const formData = new FormData(form);

            const welcomeData = {
                enabled: formData.get('welcomeEnabled') === 'on',
                channelId: formData.get('welcomeChannelId'),
                message: formData.get('welcomeMessage'),
                bannerUrl: formData.get('welcomeBannerUrl') || null
            };
            const goodbyeData = {
                enabled: formData.get('goodbyeEnabled') === 'on',
                channelId: formData.get('goodbyeChannelId'),
                message: formData.get('goodbyeMessage')
            };

            const saveWelcome = fetch(`/api/settings/${guildId}/welcome`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(welcomeData)
            });
            const saveGoodbye = fetch(`/api/settings/${guildId}/goodbye`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(goodbyeData)
            });

            Promise.all([saveWelcome, saveGoodbye])
                .then(responses => Promise.all(responses.map(res => res.json())))
                .then(data => {
                    if (data.every(d => d.success)) {
                        saveStatus.textContent = 'Changements enregistr√©s !';
                        document.getElementById('save-bar').classList.remove('visible');
                    } else {
                        saveStatus.textContent = 'Une erreur est survenue.';
                    }
                })
                .finally(() => {
                    saveButton.disabled = false;
                    saveButton.innerHTML = '<i class="fas fa-save"></i> Enregistrer les changements';
                });
        });
    </script>
</body>
</html>
