<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NexoProtect - Tableau de Bord</title>
    <link rel="stylesheet" href="/css/dashboard.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
</head>
<body>

    <div class="dashboard-layout">

        <!-- Menu latéral pour le profil -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <a href="/" class="logo">
                    <img src="/images/NexoProtect-removebg-preview.png" alt="Logo NexoProtect">
                    <span>NexoProtect</span>
                </a>
            </div>

            <% if (user) { %>
            <div class="profile-card">
                <div class="profile-banner"></div>
                <img src="https://cdn.discordapp.com/avatars/<%= user.id %>/<%= user.avatar %>.png?size=128" alt="Avatar" class="profile-avatar">
                <h2 class="profile-name"><%= user.username %></h2>
                <div class="profile-grade <%= user.grade === 'VIP' ? 'vip' : '' %>">
                    <i class="fas <%= user.grade === 'VIP' ? 'fa-crown' : 'fa-user' %>"></i>
                    <span><%= user.grade %></span>
                </div>
            </div>
            <% } %>

            <nav class="sidebar-nav">
                <a href="/dashboard" class="nav-item active"><i class="fas fa-server"></i> Serveurs</a>
                <a href="#" class="nav-item"><i class="fas fa-cog"></i> Paramètres</a>
            </nav>

            <!-- NOUVEAU : Logique d'affichage des boutons -->
            <div class="sidebar-footer">
                <% if (user) { %>
                    <% if (user.grade !== 'VIP') { %>
                        <!-- Ces boutons ne s'affichent que si l'utilisateur N'EST PAS VIP -->
                        <button id="claim-vip-btn" class="btn-vip">
                            <i class="fas fa-star"></i> 
                            <span>Réclamer VIP</span>
                        </button>
                        <a href="/premium" class="btn-premium">
                            <i class="fas fa-gem"></i>
                            <span>Devenir Premium</span>
                        </a>
                    <% } %>
                    <!-- Si l'utilisateur est VIP, les boutons ci-dessus sont masqués -->
                <% } %>
            
                <!-- Le bouton de déconnexion est toujours visible -->
                <a href="/logout" class="btn-logout">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Déconnexion</span>
                </a>
            </div>
        </aside>

        <!-- Contenu principal pour les serveurs -->
        <main class="main-content">
            <header class="main-header">
                <h1>Mes Serveurs</h1>
                <p>Sélectionnez un serveur pour commencer à le configurer.</p>
            </header>
            
            <div class="server-grid">
                <% if (guilds.length === 0) { %>
                    <p class="no-servers">Aucun serveur administrable trouvé.</p>
                <% } else { %>
                    <% guilds.forEach(guild => { %>
                        <div class="server-card">
                            <% const iconUrl = guild.icon ? `https://cdn.discordapp.com/icons/${guild.id}/${guild.icon}.png?size=128` : '/images/default-icon.png'; %>
                            <div class="card-background" style="background-image: url('<%= iconUrl %>');"></div>
                            <div class="card-content">
                                <img src="<%= iconUrl %>" alt="Icône" class="server-icon" onerror="this.src='/images/default-icon.png'">
                                <h3 class="server-name"><%= guild.name %></h3>
                            </div>
                            <div class="card-footer">
                                <% if (guild.botOnServer) { %>
                                    <a href="/manage/<%= guild.id %>" class="btn-manage"><i class="fas fa-cogs"></i> Gérer</a>
                                <% } else { %>
                                    <a href="https://discord.com/api/oauth2/authorize?client_id=1385350518267973802&guild_id=<%= guild.id %>&permissions=8&scope=bot%20applications.commands" target="_blank" class="btn-invite"><i class="fab fa-discord"></i> Inviter</a>
                                <% } %>
                            </div>
                        </div>
                    <% }); %>
                <% } %>
            </div>
        </main>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const claimVipBtn = document.getElementById('claim-vip-btn');
            if (claimVipBtn) {
                claimVipBtn.addEventListener('click', () => {
                    claimVipBtn.disabled = true;
                    claimVipBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Activation...';
                    fetch('/api/claim-vip', { method: 'POST' })
                        .then(res => res.json())
                        .then(data => {
                            if(data.success) {
                                window.location.reload();
                            } else {
                                claimVipBtn.innerHTML = data.message || 'Erreur';
                            }
                        });
                });
            }
        });
    </script>
</body>
</html>
